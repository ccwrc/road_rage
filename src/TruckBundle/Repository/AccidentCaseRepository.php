<?php

declare(strict_types=1);

namespace TruckBundle\Repository;

use Doctrine\ORM\EntityRepository;
use Doctrine\ORM\Query;

use TruckBundle\Entity\AccidentCase;

/**
 * AccidentCaseRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class AccidentCaseRepository extends EntityRepository
{

    public function findAllCasesQuery(): Query
    {
        $em = $this->getEntityManager();
        return $em->createQuery('SELECT c FROM TruckBundle:AccidentCase c ORDER BY c.id ASC');
    }

    public function findAllActiveCasesQuery(): Query
    {
        $em = $this->getEntityManager();
        return $em->createQuery('SELECT c FROM TruckBundle:AccidentCase c WHERE c.status '
            . 'LIKE :active ORDER BY c.id ASC')->setParameter('active', AccidentCase::$statusActive);
    }

    public function findAllInactiveCasesQuery(): Query
    {
        $em = $this->getEntityManager();
        return $em->createQuery('SELECT c FROM TruckBundle:AccidentCase c WHERE c.status '
            . 'LIKE :inactive ORDER BY c.id ASC')->setParameter('inactive', AccidentCase::$statusInactive);
    }

    public function findAllCasesBy(
        ?string $companyName,
        ?string $damageDescription,
        ?string $truckLocation
    ): Query
    {
        $em = $this->getEntityManager();
        $qb = $em->createQueryBuilder();

        $qb->select('ac');
        $qb->from('TruckBundle:AccidentCase', 'ac');
        $qb->innerJoin('ac.vehicle', 'v');
        $qb->orderBy('ac.id', 'ASC');


        if ($companyName !== null) {
            $qb->andWhere(
                $qb->expr()->like('v.companyName', ':companyName')
            );
            $qb->setParameter('companyName', "%$companyName%");
        }

        if ($damageDescription !== null) {
            $qb->andWhere(
                $qb->expr()->like('ac.damageDescription', ':damageDescription')
            );
            $qb->setParameter('damageDescription', "%$damageDescription%");
        }

        if ($truckLocation !== null) {
            $qb->andWhere(
                $qb->expr()->like('ac.location', ':truckLocation')
            );
            $qb->setParameter('truckLocation', "%$truckLocation%");
        }

        return $qb->getQuery();
    }
}
